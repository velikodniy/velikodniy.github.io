https://twitter.com/vlcdn/status/1351277709918351365

Рубрика «Случайные факты». В этот раз поговорим о форматах хранения изображений.

1. Если нужно сохранить изображение, но не хотите подключать библиотеки, посмотрите на Netpbm. Это простейший формат (вернее, форматы) из возможных. Изображение можно даже в «Блокноте» вручную создать. При этом поддерживаются многими программами. Например, Preview в macOS.

2. Наверное, все пользователи Windows знают про растровый формат BMP (хотя сейчас он и непопулярен). Он не так прост, как кажется. Хоть везде и говорят, что он без сжатия, изображение в нём может быть закодировано алгоритмом RLE. Но это экзотика и вы это вряд ли встретите.

3. В BMP нижняя строчка изображения кодируется первой. Поэтому если на веб-страничке картинка загружается медленно и снизу вверх, то это BMP. Да, такое иногда бывает в Интернете.

4. Есть алгоритмы сжатия (например, JPEG), которые превращают пиксели в цепочку битов. А есть форматы-контейнеры, которые такие цепочки позволяют хранить в файлах. Например, TIFF может хранить изображения, сжатые различными алгоритмами: от LZW до того же JPEG.

5. Файлы .jpg — это изображения, сжатые JPEG и помещённые в контейнер Exif, JFIF или ещё какой-то. Почему просто не сохранить сжатые данные в файл? А чтоб метаданные сохранить. Размеры, геолокация, параметры камеры — это всё примеры метаданных.

6. HEIC, популярный у пользователей продуктов Apple, — это сжатый видеокодеком H.265 единственный кадр в контейнере HEIF.

7. Видеокодеки сейчас очень хороши, так что вместо придумывания отдельного кодека для изображений, берут соответствующий кусочек видеокодека.
Внутри WebP кодек VP8, а внутри перспективного AVIF кодек AV1 (кстати, тоже в контейнере HEIF).

8. В WebP под размеры отводится 14 бит, так что максимальный размер — это 16383×16383. Маловато будет. Мне вот иногда не хватает.

9. Глаз более чувствителен к яркости, чем к цвету. Поэтому при сжатии с потерями аккуратненько сохраняем яркостную компоненту, а цвета можно шакалить по-максимуму, никто не заметит.
Более, того ещё используют субдискретизацию — иногда выбрасывают аж ¾ всех цветовых данных.

10. Я писал, что BMP необычен тем, что у него строчки снизу вверх кодируются. А в JPEG вообще всё разбито на блоки, а внутри значения змейкой по диагонали обходятся.

11. В JPEG яркость (вообще, светимость) вычисляется по формуле из BT.601. Ну, знаете, с коэффициентами (0.299, 0.587, 0.114), что вообще-то отличается от более современных стандартов. Например, от sRGB. Но так как мы тут не колориметрией занимаемся, то и так сойдёт.

12. Какой-то единой шкалы уровней сжатия JPEG нет, всегда надо уточнять.
Например, в популярной библиотеке Pillow наилучший уровень сжатия — 95. Если поставить 100, то там уже некоторые части алгоритма отключаются.

13.  RGB бывает разный (так как, очевидно, есть разные оттенки красного, синего и зелёного). Обычно под ним понимают sRGB. В файл с изображением часто можно внедрить цветовой профиль, но не факт, что программы его не проигнорируют.

14. Почему при сжатии используют дискретное косинусное преобразование, а не дискретное синусное? А потому что у DCT лучше локализация энергии сигнала.

15. Для меня GIF — это гиф, а не джиф, что бы там авторы ни говорили.

16. Изображения в формате EPS — это программы на языке PostScript (родственник Форта). Да, именно программы, которые с помощью примитивов рисуют на виртуальном холсте то, что надо отобразить. Документы PostScript можно и самому с нуля писать.

17. JPEG далеко не лучший формат ни по возможностям, ни по степени сжатия. Поэтому предлагалось много замен: JPEG2000 (от создателей самого JPEG), JPEG-XR, HEIC и т.д. Но JPEG живее всех живых.

18. Легендарный Фабрис Беллар тоже придумал свой формат ещё в 2014 году — BPG. И он (формат, конечно, а не Фабрис) тоже был основан на H.265.

19. Для сжатия без потерь интересно выглядит FLIF. В нём используется арифметическое кодирование. Но как и со всеми не очень популярными форматами, всё упирается в поддержку со стороны библиотек.

Впрочем, разработку FLIF уже остановили. На его основе сделали FUIF, который (не успев выйти из стадии прототипа) вместе с Google PIK вошёл в состав JPEG XL (https://jpeg.org/jpegxl/).
Формат выглядит интересно, но опять всё упирается поддержку программами.

20. Интересный метод — фрактальное сжатие. Записываем в файл функцию, для которой изображение — неподвижная точка. При декодировании берём какой-то шум и много раз применяем функцию. Если функция — сжимающее отображение, то исходное изображение проявится через несколько итераций.

21. Также достаточно хорошо в сжатии изображений зарекомендовали себя вейвлеты. Но в популярных форматах их по разным причинам не используют.

22. И конечно же, для сжатия пробуют использовать нейронные сети! Тема-то хайповая. Была б возможность сжимать с помощью блокчейна и баттл-рояля (ок, хайп вокруг него угас, пример не лучший), были бы и на эту тему статьи. :)

23. Очень интересно устроен DjVu. Скан страницы разделяется на цветной фон (сжимается с сильными потерями алгоритмом IW44), маску (пиксели текста, сжимаются JB2) и слой с цветом текста.


Забыл твитнуть, спасибо @ivn_finaev
 за напоминание. Среди авторов DjVu некоторые фамилии могут быть вам знакомы: Yann LeCun, Leon Bottou, Patrick Haffner, Paul Howard, Pascal Vincent, Yoshua Bengio, and Bill Riemers.
http://yann.lecun.com/ex/djvu/

24. Сжатие изображений используется внутри копировальных машин. Алгоритм JBIG2 сыграл с Xerox злую шутку. Для лучшего сжатия он ищет и группирует похожие символы. И есть ненулевая вероятность, что он подменит одну цифру другой, похожей! Не то, что мы ждём от копировальной машины.

Если кому-то интересно посмотреть, как это выглядело, вот примеры. Слева оригинал, справа — скан.
Мораль — никому нельзя доверять! Даже протекающим абстракциям.

https://pbs.twimg.com/media/EsC9YGCW8AIlSzj?format=jpg&name=large